# 第四章 系统软件设计
## 4.1 软件开发平台介绍
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;软件开发平台包括下位机的软件平台和上位机的软件平台。

### 4.1.1 下位机软件开发平台   
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;对于本系统的软件设计来说，下位机主要是通过STM32进行开关量的采集，数据的简单预处理后通过串口往上位机发送数据等。 对于STM32系列微控制器来说， 常用的集成开发环境有如Keil MDK和IAR，但是更常用的开发平台是Keil MDK,由于好多的做STM32开发的工程师都是有过51单片机的开发经验的，而51单片机的开发工具用的就是Keil,所以说Keil MDK是很多工程师所喜欢使用的开发工具。本系统选择Keil MDK5.14作为开发工具，由于Keil提供了包括C编译器、宏汇编、链接器、库管理和一个功能强大的仿真调试器在内的完整开发方案[12]，所以使用该工具开发起来能够得心应手。特别是在调试代码和配合J-Link在线调试的时候，Keil MDK更能体现出它的优势。

### 4.1.2 上位机软件开发平台  
  * 1.Python开发平台
  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;利用Python语言开发一个从串口获取数据的脚本，利用的开发平台是ILDE,IDLE是开发python程序的基本IDE（集成开发环境），用来做Python的学习是个不错的选择。当安装好python以后，IDLE就自动安装好了，不需要另外去找。同时，使用IDLE也可以非常方便的调试Python程序。
  * 2.Eric开发平台
  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;由于该平台是基于PyQt库的，而PyQt库又是一个GUI库，故该平台用于用户界面的开发。
## 4.2 下位机的软件设计
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下位机软件的设计主要包括主程序，OLED显示程序，按键子程序，LED灯显示程序，蜂鸣器驱动程序，实时时钟显示程序等。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下位机软件主函数总体设计如图4.1所示。

![](/assets/下位机主函数流程图.png)

图4.1 下位机主函数流程图
## 4.3 上位机的软件设计
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上位机的软件设计包括Python接收串口数据的脚本设计，Postgresql数据库的设计和用户界面设计。

### 4.3.1 上位机软件总体设计
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;通过python脚本读取串口数据，其中的串口数据包含流速，时间，计数值等等，该脚本还可以把从串口接收到的数据保存到Postgresql数据库，同时把数据导出到Excel文件和TXT文件中以供在用户界面中导入来做数据分析，图表输出等等，最后还可以实时显示流速的散点图。上位机由两个程序组成，相应的功能设计如图4.2和图4.3所示。

![](/assets/1号程序功能设计.png)

图4.2 1号程序功能设计

![](/assets/2号程序功能设计.png)

图4.3 2号程序功能设计
### 4.3.2 Python数据保存程序设计
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;该程序用于接收通过Zigbee无线通信技术传输来的数据，并将数据保存起来。依次把数据保存到postgresql数据库，TXT文件，Excel文件，最后还可显示实时流速散点图，如图4.4所示。

![](/assets/1分钟的实时流速散点图.png)

图4.4 1分钟的实时流速散点图

### 4.3.3 Python数据展示程序设计
（1）登录界面的设计如图4.5所示。

![](/assets/用户登录界面.png)

图4.5 用户登录界面

（2）系统主页界面的设计如图4.6所示

![](/assets/系统主页界面.png)

图4.6 系统主页界面

（3）系统各功能模块界面的设计
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在系统主页点击不同的选项即可进入不同的功能模块界面。

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1）点击曲线进入曲线功能界面，Line.ui文件所对应的界面如图4.7所示。

![](/assets/1分钟内流速相关图界面.png)

图4.7 1分钟内流速相关图界面

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在图4.7中，首先选择导入的文件类型，然后导入由python脚本生成的一分钟数据的excel文件或者TXT文件，然后分别点击散点图，折线图，柱状图后，系统就会分别画出1分钟内流速的散点图，折线图，柱状图，如图4.8所示。

![](/assets/1分钟的流速散点图.png)

图4.8 1分钟的流速散点图
























